import { NextResponse } from 'next/server';

export const revalidate = 0;

export async function GET(_request: Request) {

  const keyResult = {
    src: '',
    time: '',
    legend: {},
  };
  
  // base key get
  // const baseKey = await getBaseDateKey();

  // dfs legend get
  // const dfsLegend = await getDfsLegend(baseKey);

  // temp legend
  keyResult.legend = getTemperatureLegend();

  // temperature data get
  const temperatureData = await getDfsTemperature();
  Object.assign(keyResult, temperatureData);

  return NextResponse.json(keyResult);
}

function getTemperatureLegend() {
  const date = new Date();
  const month = new Date(date).getMonth() + 1;
  let paletteId = '';
  if (month >= 3 && month < 5) { // 3 4
    paletteId = 'E_IDFE_T_3';
  } else if (month >= 5 && month < 9) { // 5 6 7 8
    paletteId = 'E_IDFE_T_6';
  } else if (month >= 9 && month < 12) { // 9 10 11
    paletteId = 'E_IDFE_T_9';
  } else { // 12 1 2
    paletteId = 'E_IDFE_T_12';
  }

  return tempLegend.find((item) => item.id === paletteId) || {};
}

// async function getBaseDateKey() {

//   const html = await (await fetch('https://www.weather.go.kr/wgis-nuri/html/map.html')).text();

//   const [ dateKey ] = html.split('css?v=')[1].split("'");

//   return dateKey;
// }

// async function getDfsLegend(dateKey:string) {
//   const dataText = await (await fetch(`https://www.weather.go.kr/wgis-nuri/js/info/dfsLegends.js?v=${dateKey}`)).text();
//   const data = dataText.split('var dfsLegends = ')[1];
//   return JSON.parse(data) as [];
// }

async function getDfsTemperature() {
  const keyResult = {
    src: '',
    time: '',
  };
  const data = await (await fetch('https://www.weather.go.kr/wgis-nuri/dfs/list/TMP', { next: { revalidate: 0 } })).json();
  if (data && data.dfsList) {
    const [ item ] = data.dfsList;
    if (item.fctDate) {
      const key = item.fctDate as string;
      keyResult.src = `https://www.weather.go.kr/wgis-nuri/dfs/VSRT/TMP/${key}/${item.panIndex}`;
      keyResult.time = item.efcDate;
    }
  }

  return keyResult;
}

const tempLegend = [
  {
    unit: 'legend.unit.degree',
    color: [
      '#eeeeee',
      '#e5acff',
      '#da87ff',
      '#cd61ff',
      '#c23eff',
      '#b71fff',
      '#ad07ff',
      '#a000f7',
      '#9200e4',
      '#8700ce',
      '#7f00bf',
      '#cbcce8',
      '#b3b4de',
      '#9a9bd3',
      '#8081c7',
      '#6567bc',
      '#4c4eb1',
      '#3436a7',
      '#1f219d',
      '#0d1096',
      '#000390',
      '#ace5ff',
      '#87d9ff',
      '#61cdff',
      '#3ec1ff',
      '#1fb5ff',
      '#07abff',
      '#009df6',
      '#008dde',
      '#0080c4',
      '#0077b3',
      '#96fe96',
      '#69fc69',
      '#40f940',
      '#1ef31e',
      '#08e908',
      '#00d500',
      '#00bd00',
      '#00a400',
      '#008e00',
      '#008000',
      '#fff09a',
      '#ffea6e',
      '#ffe343',
      '#ffdc1f',
      '#ffd604',
      '#f9cd00',
      '#edc300',
      '#e0b900',
      '#d4b000',
      '#ccaa00',
      '#fcabab',
      '#fa8585',
      '#f86060',
      '#f63e3e',
      '#f32121',
      '#ee0b0b',
      '#e30000',
      '#d50000',
      '#c80000',
      '#bf0000',
      '#333333',
    ],
    id: 'E_IDFE_T_12',
    label: [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m35',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m25',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m15',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m5',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p5',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p15',
      null,
    ],
    key: [
      '-50.0',
      '-44.0',
      '-43.0',
      '-42.0',
      '-41.0',
      '-40.0',
      '-39.0',
      '-38.0',
      '-37.0',
      '-36.0',
      '-35.0',
      '-34.0',
      '-33.0',
      '-32.0',
      '-31.0',
      '-30.0',
      '-29.0',
      '-28.0',
      '-27.0',
      '-26.0',
      '-25.0',
      '-24.0',
      '-23.0',
      '-22.0',
      '-21.0',
      '-20.0',
      '-19.0',
      '-18.0',
      '-17.0',
      '-16.0',
      '-15.0',
      '-14.0',
      '-13.0',
      '-12.0',
      '-11.0',
      '-10.0',
      '-9.0',
      '-8.0',
      '-7.0',
      '-6.0',
      '-5.0',
      '-4.0',
      '-3.0',
      '-2.0',
      '-1.0',
      '0.0',
      '1.0',
      '2.0',
      '3.0',
      '4.0',
      '5.0',
      '6.0',
      '7.0',
      '8.0',
      '9.0',
      '10.0',
      '11.0',
      '12.0',
      '13.0',
      '14.0',
      '15.0',
      '50.0',
    ],
  },
  {
    unit: 'legend.unit.degree',
    color: [
      '#eeeeee',
      '#e5acff',
      '#da87ff',
      '#cd61ff',
      '#c23eff',
      '#b71fff',
      '#ad07ff',
      '#a000f7',
      '#9200e4',
      '#8700ce',
      '#7f00bf',
      '#cbcce8',
      '#b3b4de',
      '#9a9bd3',
      '#8081c7',
      '#6567bc',
      '#4c4eb1',
      '#3436a7',
      '#1f219d',
      '#0d1096',
      '#000390',
      '#ace5ff',
      '#87d9ff',
      '#61cdff',
      '#3ec1ff',
      '#1fb5ff',
      '#07abff',
      '#009df6',
      '#008dde',
      '#0080c4',
      '#0077b3',
      '#96fe96',
      '#69fc69',
      '#40f940',
      '#1ef31e',
      '#08e908',
      '#00d500',
      '#00bd00',
      '#00a400',
      '#008e00',
      '#008000',
      '#fff09a',
      '#ffea6e',
      '#ffe343',
      '#ffdc1f',
      '#ffd604',
      '#f9cd00',
      '#edc300',
      '#e0b900',
      '#d4b000',
      '#ccaa00',
      '#fcabab',
      '#fa8585',
      '#f86060',
      '#f63e3e',
      '#f32121',
      '#ee0b0b',
      '#e30000',
      '#d50000',
      '#c80000',
      '#bf0000',
      '#333333',
    ],
    id: 'E_IDFE_T_3',
    label: [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m20',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m10',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.z0',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p10',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p20',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p30',
      null,
    ],
    key: [
      '-50.0',
      '-30.0',
      '-28.0',
      '-27.0',
      '-26.0',
      '-25.0',
      '-24.0',
      '-23.0',
      '-22.0',
      '-21.0',
      '-20.0',
      '-19.0',
      '-18.0',
      '-17.0',
      '-16.0',
      '-15.0',
      '-14.0',
      '-13.0',
      '-12.0',
      '-11.0',
      '-10.0',
      '-9.0',
      '-8.0',
      '-7.0',
      '-6.0',
      '-5.0',
      '-4.0',
      '-3.0',
      '-2.0',
      '-1.0',
      '0.0',
      '1.0',
      '2.0',
      '3.0',
      '4.0',
      '5.0',
      '6.0',
      '7.0',
      '8.0',
      '9.0',
      '10.0',
      '11.0',
      '12.0',
      '13.0',
      '14.0',
      '15.0',
      '16.0',
      '17.0',
      '18.0',
      '19.0',
      '20.0',
      '21.0',
      '22.0',
      '23.0',
      '24.0',
      '25.0',
      '26.0',
      '27.0',
      '28.0',
      '29.0',
      '30.0',
      '50.0',
    ],
  },
  {
    unit: 'legend.unit.degree',
    color: [
      '#eeeeee',
      '#e5acff',
      '#da87ff',
      '#cd61ff',
      '#c23eff',
      '#b71fff',
      '#ad07ff',
      '#a000f7',
      '#9200e4',
      '#8700ce',
      '#7f00bf',
      '#cbcce8',
      '#b3b4de',
      '#9a9bd3',
      '#8081c7',
      '#6567bc',
      '#4c4eb1',
      '#3436a7',
      '#1f219d',
      '#0d1096',
      '#000390',
      '#ace5ff',
      '#87d9ff',
      '#61cdff',
      '#3ec1ff',
      '#1fb5ff',
      '#07abff',
      '#009df6',
      '#008dde',
      '#0080c4',
      '#0077b3',
      '#96fe96',
      '#69fc69',
      '#40f940',
      '#1ef31e',
      '#08e908',
      '#00d500',
      '#00bd00',
      '#00a400',
      '#008e00',
      '#008000',
      '#fff09a',
      '#ffea6e',
      '#ffe343',
      '#ffdc1f',
      '#ffd604',
      '#f9cd00',
      '#edc300',
      '#e0b900',
      '#d4b000',
      '#ccaa00',
      '#fcabab',
      '#fa8585',
      '#f86060',
      '#f63e3e',
      '#f32121',
      '#ee0b0b',
      '#e30000',
      '#d50000',
      '#c80000',
      '#bf0000',
      '#333333',
    ],
    id: 'E_IDFE_T_6',
    label: [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m1',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p9',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p19',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p29',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p39',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p49',
      null,
    ],
    key: [
      '-50.0',
      '-10.0',
      '-9.0',
      '-8.0',
      '-7.0',
      '-6.0',
      '-5.0',
      '-4.0',
      '-3.0',
      '-2.0',
      '-1.0',
      '0.0',
      '1.0',
      '2.0',
      '3.0',
      '4.0',
      '5.0',
      '6.0',
      '7.0',
      '8.0',
      '9.0',
      '10.0',
      '11.0',
      '12.0',
      '13.0',
      '14.0',
      '15.0',
      '16.0',
      '17.0',
      '18.0',
      '19.0',
      '20.0',
      '21.0',
      '22.0',
      '23.0',
      '24.0',
      '25.0',
      '26.0',
      '27.0',
      '28.0',
      '29.0',
      '30.0',
      '31.0',
      '32.0',
      '33.0',
      '34.0',
      '35.0',
      '36.0',
      '37.0',
      '38.0',
      '39.0',
      '40.0',
      '41.0',
      '42.0',
      '43.0',
      '44.0',
      '45.0',
      '46.0',
      '47.0',
      '48.0',
      '49.0',
      '50.0',
    ],
  },
  {
    unit: 'legend.unit.degree',
    color: [
      '#eeeeee',
      '#e5acff',
      '#da87ff',
      '#cd61ff',
      '#c23eff',
      '#b71fff',
      '#ad07ff',
      '#a000f7',
      '#9200e4',
      '#8700ce',
      '#7f00bf',
      '#cbcce8',
      '#b3b4de',
      '#9a9bd3',
      '#8081c7',
      '#6567bc',
      '#4c4eb1',
      '#3436a7',
      '#1f219d',
      '#0d1096',
      '#000390',
      '#ace5ff',
      '#87d9ff',
      '#61cdff',
      '#3ec1ff',
      '#1fb5ff',
      '#07abff',
      '#009df6',
      '#008dde',
      '#0080c4',
      '#0077b3',
      '#96fe96',
      '#69fc69',
      '#40f940',
      '#1ef31e',
      '#08e908',
      '#00d500',
      '#00bd00',
      '#00a400',
      '#008e00',
      '#008000',
      '#fff09a',
      '#ffea6e',
      '#ffe343',
      '#ffdc1f',
      '#ffd604',
      '#f9cd00',
      '#edc300',
      '#e0b900',
      '#d4b000',
      '#ccaa00',
      '#fcabab',
      '#fa8585',
      '#f86060',
      '#f63e3e',
      '#f32121',
      '#ee0b0b',
      '#e30000',
      '#d50000',
      '#c80000',
      '#bf0000',
      '#333333',
    ],
    id: 'E_IDFE_T_9',
    label: [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m20',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.m10',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.z0',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p10',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p20',
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      'legend.num.p30',
      null,
    ],
    key: [
      '-50.0',
      '-30.0',
      '-28.0',
      '-27.0',
      '-26.0',
      '-25.0',
      '-24.0',
      '-23.0',
      '-22.0',
      '-21.0',
      '-20.0',
      '-19.0',
      '-18.0',
      '-17.0',
      '-16.0',
      '-15.0',
      '-14.0',
      '-13.0',
      '-12.0',
      '-11.0',
      '-10.0',
      '-9.0',
      '-8.0',
      '-7.0',
      '-6.0',
      '-5.0',
      '-4.0',
      '-3.0',
      '-2.0',
      '-1.0',
      '0.0',
      '1.0',
      '2.0',
      '3.0',
      '4.0',
      '5.0',
      '6.0',
      '7.0',
      '8.0',
      '9.0',
      '10.0',
      '11.0',
      '12.0',
      '13.0',
      '14.0',
      '15.0',
      '16.0',
      '17.0',
      '18.0',
      '19.0',
      '20.0',
      '21.0',
      '22.0',
      '23.0',
      '24.0',
      '25.0',
      '26.0',
      '27.0',
      '28.0',
      '29.0',
      '30.0',
      '50.0',
    ],
  },
];